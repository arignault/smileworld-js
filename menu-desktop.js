// Variables globales
let isInitialized = false;
let isWrapperOpen = false;
let isAnimating = false; // Nouveau flag pour √©viter les animations simultan√©es

// Configuration des menus
const menuConfig = [
    {
        buttonSelector: '.nav_menu_item:has(button:contains("Nos Parcs"))',
        containerSelector: '.parc_menu_desktop',
        isOpen: false
    },
    {
        buttonSelector: '.nav_menu_item:has(button:contains("Activit√©s"))',
        containerSelector: '.activites_menu_desktop',
        isOpen: false
    },
    {
        buttonSelector: '.nav_menu_item:has(button:contains("Offres"))',
        containerSelector: '.offres_menu_desktop',
        isOpen: false
    }
];

// Fonction pour obtenir le display calcul√© par Webflow
function getComputedDisplay(element) {
    if (!element) return 'none';
    return window.getComputedStyle(element).display;
}

// Fonction pour fermer tous les menus et le wrapper
function closeAllMenusAndWrapper(menuWrapper) {
    if (isAnimating) {
        console.log('‚ö†Ô∏è Animation en cours, fermeture ignor√©e');
        return;
    }

    isAnimating = true;
    console.log('üîÑ D√©but de la fermeture...');

    try {
        // Cr√©er une timeline pour l'animation de fermeture
        const tl = gsap.timeline({
            onComplete: () => {
                menuWrapper.style.display = 'none';
                isWrapperOpen = false;
                isAnimating = false;
                console.log('‚úÖ Fermeture termin√©e');
            }
        });

        // Fermer tous les menus avec animation
        menuConfig.forEach(menu => {
            const menuButton = document.querySelector(menu.buttonSelector);
            const menuContainer = document.querySelector(menu.containerSelector);
            
            if (menuButton) {
                const navMenuItem = menuButton.closest('.nav_menu_item');
                if (navMenuItem) {
                    tl.to(navMenuItem, {
                        opacity: 0,
                        duration: 0.2,
                        ease: "power2.out"
                    }, 0);
                }
            }
            
            if (menuContainer) {
                tl.to(menuContainer, {
                    opacity: 0,
                    duration: 0.2,
                    ease: "power2.out",
                    onComplete: () => {
                        menuContainer.style.display = 'none';
                        menu.isOpen = false;
                    }
                }, 0);
            }
        });

        // Animation du wrapper
        tl.to(menuWrapper, {
            opacity: 0,
            duration: 0.3,
            ease: "power2.out"
        }, 0);

    } catch (error) {
        console.error('‚ùå Erreur lors de la fermeture:', error);
        isAnimating = false;
    }
}

// Fonction pour initialiser le menu desktop
export function initMenuDesktop() {
    // √âviter la double initialisation
    if (isInitialized) {
        console.log('‚ö†Ô∏è Menu desktop d√©j√† initialis√©');
        return;
    }

    console.log('üöÄ Initialisation du menu desktop...');

    // S√©lection du wrapper
    const menuWrapper = document.querySelector('.desktop_menu_wrapper');
    if (!menuWrapper) {
        console.warn('‚ö†Ô∏è Menu wrapper non trouv√©');
        return;
    }

    // Debug des s√©lecteurs
    console.log('üîç Recherche des √©l√©ments...');
    
    // Afficher tous les √©l√©ments de menu pour le d√©bogage
    const allMenuItems = document.querySelectorAll('.nav_menu_item');
    console.log('Tous les √©l√©ments nav_menu_item:', allMenuItems.length);
    allMenuItems.forEach((item, index) => {
        console.log(`Menu item ${index + 1}:`, {
            classes: item.className,
            html: item.innerHTML,
            buttons: item.querySelectorAll('button'),
            links: item.querySelectorAll('a')
        });
    });

    // Initialisation de chaque menu
    menuConfig.forEach(menu => {
        // Essayer diff√©rents s√©lecteurs
        const possibleSelectors = [
            menu.buttonSelector,
            `.nav_menu_item button:contains("${menu.buttonSelector.split(':contains("')[1].split('")')[0]}")`,
            `.nav_menu_item:has(button:contains("${menu.buttonSelector.split(':contains("')[1].split('")')[0]}"))`,
            `[data-nav-link-desktop-${menu.containerSelector.split('_')[0]}]`
        ];

        let menuButton = null;
        let usedSelector = '';

        for (const selector of possibleSelectors) {
            const elements = document.querySelectorAll(selector);
            if (elements.length > 0) {
                menuButton = elements[0];
                usedSelector = selector;
                break;
            }
        }

        const menuContainer = document.querySelector(menu.containerSelector);

        console.log('üîç √âl√©ments trouv√©s pour', menu.containerSelector, ':', {
            menuButton: menuButton ? '‚úÖ' : '‚ùå',
            menuContainer: menuContainer ? '‚úÖ' : '‚ùå',
            usedSelector: usedSelector || 'Aucun s√©lecteur ne fonctionne'
        });

        // V√©rification que les √©l√©ments existent
        if (!menuButton || !menuContainer) {
            console.warn('‚ö†Ô∏è Menu desktop: √©l√©ments non trouv√©s pour', menu.containerSelector);
            return;
        }

        // Stockage du display original
        const originalDisplay = getComputedDisplay(menuContainer);
        console.log('üìù Display original du menu:', originalDisplay);

        // Fermer le menu au d√©marrage
        menuContainer.style.display = 'none';
        menuContainer.style.opacity = '0';
        console.log('üîí Menu ferm√© au d√©marrage:', menu.containerSelector);

        // Ajout de l'√©couteur d'√©v√©nement sur le bouton
        menuButton.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();

            if (isAnimating) {
                console.log('‚ö†Ô∏è Animation en cours, clic ignor√©');
                return;
            }

            console.log('üñ±Ô∏è Clic sur le bouton du menu:', menu.containerSelector);
            
            if (menu.isOpen) {
                // Si le menu est d√©j√† ouvert, tout fermer
                closeAllMenusAndWrapper(menuWrapper);
            } else {
                isAnimating = true;
                console.log('üîÑ D√©but de l\'ouverture...');

                try {
                    // Cr√©er une timeline pour l'animation d'ouverture
                    const tl = gsap.timeline({
                        onComplete: () => {
                            isAnimating = false;
                            console.log('‚úÖ Ouverture termin√©e');
                        }
                    });

                    // Ouvrir le wrapper si c'est le premier clic
                    if (!isWrapperOpen) {
                        menuWrapper.style.display = 'flex';
                        tl.to(menuWrapper, {
                            opacity: 1,
                            duration: 0.3,
                            ease: "power2.out"
                        });
                        isWrapperOpen = true;
                    }
                    
                    // Fermer tous les autres menus
                    menuConfig.forEach(otherMenu => {
                        if (otherMenu !== menu) {
                            const otherContainer = document.querySelector(otherMenu.containerSelector);
                            const otherButton = document.querySelector(otherMenu.buttonSelector);
                            
                            if (otherContainer) {
                                tl.to(otherContainer, {
                                    opacity: 0,
                                    duration: 0.2,
                                    ease: "power2.out",
                                    onComplete: () => {
                                        otherContainer.style.display = 'none';
                                        otherMenu.isOpen = false;
                                    }
                                }, 0);
                            }
                            
                            if (otherButton) {
                                const otherNavMenuItem = otherButton.closest('.nav_menu_item');
                                if (otherNavMenuItem) {
                                    tl.to(otherNavMenuItem, {
                                        opacity: 0,
                                        duration: 0.2,
                                        ease: "power2.out"
                                    }, 0);
                                    otherNavMenuItem.classList.remove('active');
                                }
                            }
                        }
                    });
                    
                    // Ouvrir le menu cliqu√©
                    menuContainer.style.display = 'block';
                    tl.to(menuContainer, {
                        opacity: 1,
                        duration: 0.3,
                        ease: "power2.out"
                    });
                    
                    const navMenuItem = menuButton.closest('.nav_menu_item');
                    if (navMenuItem) {
                        tl.to(navMenuItem, {
                            opacity: 1,
                            duration: 0.3,
                            ease: "power2.out"
                        });
                        navMenuItem.classList.add('active');
                    }
                    
                    menu.isOpen = true;

                } catch (error) {
                    console.error('‚ùå Erreur lors de l\'ouverture:', error);
                    isAnimating = false;
                }
            }
        });
    });

    // Fermeture du wrapper et des menus au clic en dehors
    document.addEventListener('click', (e) => {
        if (isAnimating) return;

        const isClickOutside = !menuConfig.some(menu => 
            e.target.closest(menu.buttonSelector) || 
            e.target.closest(menu.containerSelector)
        ) && !e.target.closest('.desktop_menu_wrapper');
        
        if (isClickOutside && isWrapperOpen) {
            closeAllMenusAndWrapper(menuWrapper);
        }
    });

    isInitialized = true;
    console.log('‚úÖ Initialisation du menu desktop termin√©e');
}

// Suppression de l'auto-initialisation pour √©viter la double initialisation
// L'initialisation se fait maintenant uniquement via main_gsap.js
